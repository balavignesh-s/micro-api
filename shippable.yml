# language setting
language: node_js

# version numbers, testing against two versions of node
node_js:
  - 0.10.33

env:
  global:
    - XUNIT_FILE=./shippable/testresults/result.xml
    - API_PORT=80
    - GCP_PROJECT_ID=shippable-gke # existing GCP project name
    - MICROSERVICE_NAME=micro-api
    - REGISTRY_ACCOUNT=gcr.io/$GCP_PROJECT_ID # image registry account name, e.g. Docker Hub account

build:
  pre_ci:
    - docker build -t $REGISTRY_ACCOUNT/$MICROSERVICE_NAME:latest .
    - node --version
    - mkdir -p ./shippable/testresults
    - mkdir -p ./shippable/codecoverage
  pre_ci_boot:
    image_name: $REGISTRY_ACCOUNT/$MICROSERVICE_NAME
    image_tag: latest
    pull: false
    options: --privileged=true
  ci:
#    - echo "================= Adding gclould binaries ============ "
#    - CLOUD_SDK_REPO="cloud-sdk-$(lsb_release -c -s)"
#    - echo "deb http://packages.cloud.google.com/apt $CLOUD_SDK_REPO main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
#    - curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
#    - sudo apt-get update && sudo apt-get install google-cloud-sdk
    - npm install
    - grunt
  post_ci:
    - ./node_modules/.bin/istanbul cover grunt -- -u tdd
    - ./node_modules/.bin/istanbul report cobertura --dir  ./shippable/codecoverage/
    - echo $BUILD_NUMBER > ~/buildConfig.txt
    - docker tag -f $REGISTRY_ACCOUNT/$MICROSERVICE_NAME:latest $REGISTRY_ACCOUNT/$MICROSERVICE_NAME:$BRANCH.$BUILD_NUMBER
#    - docker push $REGISTRY_ACCOUNT/$MICROSERVICE_NAME:$BRANCH.$BUILD_NUMBER

integrations:
    hub:
      - integrationName: "GCR-shippable-gke"
        type: gcr
        branches:
          only:
            - gcr
