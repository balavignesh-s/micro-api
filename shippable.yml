# language setting
language: node_js

# version numbers, testing against two versions of node
node_js:
  - 0.10.33

env:
  global:
    - XUNIT_FILE=./shippable/testresults/result.xml
    - API_PORT=80
    - GCP_PROJECT_NAME=Shippable-GKE # existing GCP project name
    - MICROSERVICE_NAME=micro-api
    - REGISTRY_ACCOUNT=gcr.io/$GCP_PROJECT_NAME # image registry account name, e.g. Docker Hub account
    # encrypted variable for AWS_ACCESS_KEY_ID, unique to each Shippable project
    # you must generate your own hash within Shippable project settings
    - secure: KNPdy2sc6Y/jiy9/yd7m3mWYLWRK/lkDcM2hF7A699c8WuGcXZ0DoO3Qb59HuZRGoYA6GPURwprusLySSC5rKV7wTJBSDA4GQCoUboJ7ZtRrFm5gMF8p/uQVrLCyb4GmaX28BqJzONrH936j9fFeSsTJpJhWMGjeSJaOi881tGXJb7QZNDkpTtWsN7yg8eU2VJklxlNGVXEZsTxXrtdY6Jw/TiSsnv6DhmB3bqw+0VAWu+smbVEtcYdPyx2S2kpmqisTHcvJBck98d7lt0ay9MNhNCtV7AAJkRwc64dYs44G2Tcy+Lk+baCvm0uJSEmZ5nXk1f7bjb3xRbiPObgm9A==
    # encrypted variable for AWS_SECRET_ACCESS_KEY, unique to each Shippable project
    # you must generate your own hash within Shippable project settings
    - secure: Z64+B7KlurxU44tqlsrQhIxvbEw1sdVLmhBW6LV6nQK6bbxI3LxmlUsOlzhtoaTnvbam8TWA703JOSD9YC2hZ/7HI/P0IGsvOh7uF8ZcgXu0/LBKz8N47yPHLaRJHOVEPk6R2XDaRy0kCry67aZhonLMnjkZHe5HsJcKUxlK7g/bYm3evnzf/+ozPCR85e8IxzdjFLC8VY6QId6LmBGbrq3lLa97Mm+9p47oZX4ZvpXsG8FIKjXO7PHjyL/kokjDyh6lCso1uGsUtEwVJ7gO6K/Ccs51j81q5VdzoWoRoCWadlt/8xevkv48BjYg8J/B3bBPIj5F779LF0ytjz9D7A==

build:
  pre_ci:
    - docker build -t $REGISTRY_ACCOUNT/$MICROSERVICE_NAME:latest .
    - node --version
    - mkdir -p ./shippable/testresults
    - mkdir -p ./shippable/codecoverage
  pre_ci_boot:
    image_name: $REGISTRY_ACCOUNT/$MICROSERVICE_NAME
    image_tag: latest
    pull: false
    options: --privileged=true
  ci:
    - npm install
    - grunt
  post_ci:
    - ./node_modules/.bin/istanbul cover grunt -- -u tdd
    - ./node_modules/.bin/istanbul report cobertura --dir  ./shippable/codecoverage/
    - echo $BUILD_NUMBER > ~/buildConfig.txt
    - docker tag -f $REGISTRY_ACCOUNT/$MICROSERVICE_NAME:latest $REGISTRY_ACCOUNT/$MICROSERVICE_NAME:$BRANCH.$BUILD_NUMBER
    - docker push $REGISTRY_ACCOUNT/$MICROSERVICE_NAME:$BRANCH.$BUILD_NUMBER

integrations:
    hub:
      - integrationName: "GCR"
        type: gcr
        branches:
          only:
            - gcr
